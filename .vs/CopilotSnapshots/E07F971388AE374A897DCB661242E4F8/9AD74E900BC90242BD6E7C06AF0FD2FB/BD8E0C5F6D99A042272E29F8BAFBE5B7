using System.Drawing;
using System.Drawing.Drawing2D;
using System.IO;
using System.Windows.Forms;
using LPR381_Assignment.UI.Controls;
using LPR381_Assignment.UI.Helpers;
using LPR381_Assignment.UI.Themes;

namespace LPR381_Assignment
{
    // Main form for the LP/IP Solver application
    public partial class TabbedMainForm : Form
    {
        // Model state
        private string _rawModelText = string.Empty;
        private object? _lastSolveResult = null;

        // Menu & Status controls
        private MenuStrip mainMenu;
        private StatusStrip statusStrip;
        private ToolStripStatusLabel sbStatus;
        private ToolStripStatusLabel sbAlgo;
        private ToolStripStatusLabel sbIter;
        private ToolStripStatusLabel sbNode;

        // Host panel that carries only content (adds top/bottom padding)
        private Panel contentHost;

        // Hidden-header TabControl
        private HiddenTabControl tabMain;

        // Tab: Model Input
        private TabPage tabModelInput;
        private Button btnLoadModelFile;
        private Button btnSaveModelFile;
        private Button btnValidateInput;
        private Label lblModelFormat;
        private DataGridView dgvObjective;
        private DataGridView dgvConstraints;
        private DataGridView dgvSignRestrictions;
        private ComboBox cmbProblemType;
        private ComboBox cmbObjectiveSense;
        private Label lblProblemType;
        private Label lblObjectiveSense;

        // Tab: Algorithm
        private TabPage tabAlgorithm;
        private StyledGroupPanel grpAlgorithms;
        private RadioButton rbPrimalSimplex;
        private RadioButton rbRevisedPrimalSimplex;
        private RadioButton rbBnBSimplex;
        private RadioButton rbCuttingPlane;
        private RadioButton rbBnBKnapsack;
        private Button btnSolve;
        private StyledGroupPanel grpOptions;
        private CheckBox chkBinary;
        private CheckBox chkGeneralInteger;

        // Tab: Canonical Form
        private TabPage tabCanonical;
        private DataGridView dgvCanonicalTableau;
        private RichTextBox rtbCanonicalNotes;

        // Tab: Iterations
        private TabPage tabIterations;
        private ListView lvIterations;
        private Button btnExpandAll;
        private Button btnCollapseAll;

        // Tab: Results
        private TabPage tabResults;
        private RichTextBox rtbResultsSummary;
        private Button btnExportResults;
        private Label lblRoundingNote;

        // Tab: Sensitivity
        private TabPage tabSensitivity;
        private StyledGroupPanel pnlSA_VarNonBasic;
        private ComboBox saNB_VarSelect;
        private Button saNB_ShowRange;
        private NumericUpDown saNB_ApplyDelta;
        private Button saNB_Apply;
        private ListView saNB_Output;

        private StyledGroupPanel pnlSA_VarBasic;
        private ComboBox saB_VarSelect;
        private Button saB_ShowRange;
        private NumericUpDown saB_ApplyDelta;
        private Button saB_Apply;
        private ListView saB_Output;

        private StyledGroupPanel pnlSA_RHS;
        private ComboBox saRHS_ConSelect;
        private Button saRHS_ShowRange;
        private NumericUpDown saRHS_ApplyDelta;
        private Button saRHS_Apply;
        private ListView saRHS_Output;

        private StyledGroupPanel pnlSA_Column;
        private ComboBox saCol_VarSelect;
        private Button saCol_ShowRange;
        private Button saCol_EditCoeffs;
        private ListView saCol_Output;

        private StyledGroupPanel pnlSA_AddActivity;
        private Button saAddAct_Add;
        private ListView saAddAct_Output;

        private StyledGroupPanel pnlSA_AddConstraint;
        private Button saAddCon_Add;
        private ListView saAddCon_Output;

        private StyledGroupPanel pnlSA_ShadowPrices;
        private Button saShadow_Show;
        private ListView saShadow_Output;

        private StyledGroupPanel pnlSA_Duality;
        private Button saDual_Build;
        private Button saDual_Solve;
        private Button saDual_Verify;
        private ListView saDual_Output;

        // Tab: Node Explorer
        private TabPage tabNodes;
        private SplitContainer splitNodes;
        private TreeView tvNodes;
        private Panel nodeDetailsPanel;
        private Label lblNodeTitle;
        private Label lblNodeStatus;
        private Label lblNodeBound;
        private Label lblNodeIncumbent;
        private ListView lvNodeIterations;

        // Tab: Cuts
        private TabPage tabCuts;
        private ListView lvCuts;
        private Button btnAddCut;
        private Button btnClearCuts;

        // Initializes a new instance of the form
        public TabbedMainForm()
        {
            Text = "LP/IP Solver - LPR381 Assignment";
            Width = 1280;
            Height = 860;
            MinimumSize = new Size(1100, 700);
            StartPosition = FormStartPosition.CenterScreen;

            // Reduce flicker for smoother UI
            SetStyle(ControlStyles.AllPaintingInWmPaint | ControlStyles.OptimizedDoubleBuffer | ControlStyles.UserPaint, true);
            UpdateStyles();

            InitializeComponents();
        }

        // Custom window creation params for double-buffering
        protected override CreateParams CreateParams
        {
            get
            {
                var cp = base.CreateParams;
                cp.ExStyle |= 0x02000000; // WS_EX_COMPOSITED
                return cp;
            }
        }

        // -------------------- Init & Build UI --------------------

        // Builds all UI components and applies theme
        private void InitializeComponents()
        {
            BuildMenu();
            BuildStatusStrip();

            // Content host with ONLY top/bottom padding for the main content
            contentHost = new Panel
            {
                Dock = DockStyle.Fill,
                BackColor = AppTheme.Background,
                Padding = new Padding(0, 12, 0, 12) // margin from menu/status
            };
            Controls.Add(contentHost);

            // Tabs (hidden headers) inside content host
            tabMain = new HiddenTabControl { Dock = DockStyle.Fill };
            contentHost.Controls.Add(tabMain);

            BuildTabModelInput();
            BuildTabAlgorithm();
            BuildTabCanonical();
            BuildTabIterations();
            BuildTabResults();
            BuildTabSensitivity();
            BuildTabNodes();
            BuildTabCuts();

            tabMain.TabPages.AddRange(new[]
            {
                tabModelInput, tabAlgorithm, tabCanonical, tabIterations, tabResults, tabSensitivity, tabNodes, tabCuts
            });

            ApplyTheme();
        }

        // Builds the main menu bar
        private void BuildMenu()
        {
            mainMenu = new MenuStrip();
            var mFile = new ToolStripMenuItem("&File");
            var mSolve = new ToolStripMenuItem("&Solve");
            var mAnalysis = new ToolStripMenuItem("&Analysis");
            var mView = new ToolStripMenuItem("&View");
            var mHelp = new ToolStripMenuItem("&Help");

            // File
            var miOpen = new ToolStripMenuItem("Open Model…", null, (s, e) => BtnLoadModelFile_Click(s, e));
            var miSave = new ToolStripMenuItem("Save Model…", null, (s, e) => BtnSaveModelFile_Click(s, e));
            var miExport = new ToolStripMenuItem("Export Results…", null, (s, e) => BtnExportResults_Click(s, e));
            var miExit = new ToolStripMenuItem("Exit", null, (s, e) => Close());
            mFile.DropDownItems.AddRange(new ToolStripItem[] { miOpen, miSave, new ToolStripSeparator(), miExport, new ToolStripSeparator(), miExit });

            // Solve
            var miAlgPrimal = new ToolStripMenuItem("Primal Simplex") { CheckOnClick = true };
            var miAlgRevised = new ToolStripMenuItem("Revised Primal Simplex") { CheckOnClick = true, Checked = true };
            var miAlgBnB = new ToolStripMenuItem("Branch & Bound (Simplex)") { CheckOnClick = true };
            var miAlgCuts = new ToolStripMenuItem("Cutting Plane") { CheckOnClick = true };
            var miAlgKnapsack = new ToolStripMenuItem("Branch & Bound (Knapsack)") { CheckOnClick = true };
            miAlgPrimal.Click += (s, e) => { rbPrimalSimplex.Checked = true; SetAlgoStatus("Primal Simplex"); };
            miAlgRevised.Click += (s, e) => { rbRevisedPrimalSimplex.Checked = true; SetAlgoStatus("Revised Primal Simplex"); };
            miAlgBnB.Click += (s, e) => { rbBnBSimplex.Checked = true; SetAlgoStatus("B&B (Simplex)"); };
            miAlgCuts.Click += (s, e) => { rbCuttingPlane.Checked = true; SetAlgoStatus("Cutting Plane"); };
            miAlgKnapsack.Click += (s, e) => { rbBnBKnapsack.Checked = true; SetAlgoStatus("B&B (Knapsack)"); };
            var miSolveNow = new ToolStripMenuItem("Solve Now", null, (s, e) => BtnSolve_Click(s, e));
            mSolve.DropDownItems.AddRange(new ToolStripItem[] { miAlgPrimal, miAlgRevised, miAlgBnB, miAlgCuts, miAlgKnapsack, new ToolStripSeparator(), miSolveNow });

            // Analysis
            var miSensitivity = new ToolStripMenuItem("Sensitivity…", null, (s, e) => tabMain.SelectedTab = tabSensitivity);
            var miShadow = new ToolStripMenuItem("Shadow Prices", null, (s, e) => saShadow_Show.PerformClick());
            var miDualBuild = new ToolStripMenuItem("Build Dual", null, (s, e) => saDual_Build.PerformClick());
            var miDualSolve = new ToolStripMenuItem("Solve Dual", null, (s, e) => saDual_Solve.PerformClick());
            var miDualVerify = new ToolStripMenuItem("Verify Duality", null, (s, e) => saDual_Verify.PerformClick());
            mAnalysis.DropDownItems.AddRange(new ToolStripItem[] { miSensitivity, new ToolStripSeparator(), miShadow, new ToolStripSeparator(), miDualBuild, miDualSolve, miDualVerify });

            // View
            var miViewCanonical = new ToolStripMenuItem("Canonical Form", null, (s, e) => tabMain.SelectedTab = tabCanonical);
            var miViewIterations = new ToolStripMenuItem("Iterations", null, (s, e) => tabMain.SelectedTab = tabIterations);
            var miViewResults = new ToolStripMenuItem("Results", null, (s, e) => tabMain.SelectedTab = tabResults);
            var miViewNodes = new ToolStripMenuItem("Node Explorer", null, (s, e) => tabMain.SelectedTab = tabNodes);
            var miViewCuts = new ToolStripMenuItem("Cuts", null, (s, e) => tabMain.SelectedTab = tabCuts);
            mView.DropDownItems.AddRange(new ToolStripItem[] { miViewCanonical, miViewIterations, miViewResults, miViewNodes, miViewCuts });

            // Help
            var miAbout = new ToolStripMenuItem("About", null, (s, e) => MessageBox.Show("LP/IP Solver GUI\nAssignment scaffolding (GUI only).", "About", MessageBoxButtons.OK, MessageBoxIcon.Information));
            mHelp.DropDownItems.Add(miAbout);

            // Add top-level menus
            mainMenu.Items.AddRange(new ToolStripItem[] { mFile, mSolve, mAnalysis, mView, mHelp });
            mainMenu.Dock = DockStyle.Top;

            Controls.Add(mainMenu);
            this.MainMenuStrip = mainMenu;
        }

        // Builds the status strip at the bottom
        private void BuildStatusStrip()
        {
            statusStrip = new StatusStrip();
            sbStatus = new ToolStripStatusLabel("Ready");
            sbAlgo = new ToolStripStatusLabel("Alg: Revised Simplex");
            sbIter = new ToolStripStatusLabel("Iter: 0");
            sbNode = new ToolStripStatusLabel("Node: –");
            statusStrip.Items.AddRange(new ToolStripItem[] { sbStatus, new ToolStripStatusLabel("|"), sbAlgo, new ToolStripStatusLabel("|"), sbIter, new ToolStripStatusLabel("|"), sbNode });
            statusStrip.Dock = DockStyle.Bottom;
            Controls.Add(statusStrip);
        }

        // Builds the Model Input tab
        private void BuildTabModelInput()
        {
            tabModelInput = new TabPage("Model Input");

            var mainPanel = new Panel
            {
                Dock = DockStyle.Fill,
                Padding = new Padding(20),
                BackColor = Color.Transparent
            };

            var topPanel = new Panel { Height = 80, Dock = DockStyle.Top, BackColor = Color.Transparent };

            btnLoadModelFile = new Button { Text = "Load Model From File", Width = 200, Height = 40, Top = 20 };
            btnSaveModelFile = new Button { Text = "Save Model To File", Width = 180, Height = 40, Top = 20 };
            btnValidateInput = new Button { Text = "Validate Input", Width = 160, Height = 40, Top = 20 };
            btnLoadModelFile.Click += BtnLoadModelFile_Click;
            btnSaveModelFile.Click += BtnSaveModelFile_Click;
            btnValidateInput.Click += BtnValidateInput_Click;

            void CenterTopButtons()
            {
                int totalWidth = btnLoadModelFile.Width + 20 + btnSaveModelFile.Width + 20 + btnValidateInput.Width;
                int startX = Math.Max(0, (topPanel.ClientSize.Width - totalWidth) / 2);
                btnLoadModelFile.Left = startX;
                btnSaveModelFile.Left = startX + btnLoadModelFile.Width + 20;
                btnValidateInput.Left = btnSaveModelFile.Left + btnSaveModelFile.Width + 20;
            }
            topPanel.Resize += (s, e) => CenterTopButtons();
            topPanel.Controls.AddRange(new Control[] { btnLoadModelFile, btnSaveModelFile, btnValidateInput });
            topPanel.CreateControl();
            CenterTopButtons();

            var formatPanel = new Panel { Height = 50, Dock = DockStyle.Top, BackColor = Color.Transparent, Padding = new Padding(0, 10, 0, 0) };
            lblModelFormat = new Label
            {
                Dock = DockStyle.Fill,
                Text = "Format: First line = max/min with signs & coefficients. Then constraints. Last line = sign restrictions.",
                TextAlign = ContentAlignment.MiddleLeft
            };
            formatPanel.Controls.Add(lblModelFormat);

            var selectionPanel = new Panel { Height = 60, Dock = DockStyle.Top, BackColor = Color.Transparent, Padding = new Padding(0, 10, 0, 10) };
            lblProblemType = new Label { Text = "Problem Type:", Left = 0, Top = 0, Width = 120, Height = 20, TextAlign = ContentAlignment.MiddleLeft };
            cmbProblemType = new ComboBox { Left = 0, Top = 25, Width = 180, DropDownStyle = ComboBoxStyle.DropDownList };
            cmbProblemType.Items.AddRange(new[] { "LP", "Binary IP", "Knapsack" });
            cmbProblemType.SelectedIndex = 0;

            lblObjectiveSense = new Label { Text = "Objective Sense:", Left = 200, Top = 0, Width = 140, Height = 20, TextAlign = ContentAlignment.MiddleLeft };
            cmbObjectiveSense = new ComboBox { Left = 200, Top = 25, Width = 180, DropDownStyle = ComboBoxStyle.DropDownList };
            cmbObjectiveSense.Items.AddRange(new[] { "Maximize", "Minimize" });
            cmbObjectiveSense.SelectedIndex = 0;

            selectionPanel.Controls.AddRange(new Control[] { lblProblemType, cmbProblemType, lblObjectiveSense, cmbObjectiveSense });

            var objPanel = new Panel { Height = 200, Dock = DockStyle.Top, BackColor = Color.Transparent, Padding = new Padding(0, 10, 0, 10) };
            var lblObjective = new Label { Text = "Objective Function (sign, coefficient per variable):", Dock = DockStyle.Top, Height = 25, TextAlign = ContentAlignment.BottomLeft };
            var spacerObjective = new Panel { Dock = DockStyle.Top, Height = 12 };
            dgvObjective = new DataGridView { Dock = DockStyle.Fill, AllowUserToAddRows = true, AllowUserToDeleteRows = true, AutoSizeColumnsMode = DataGridViewAutoSizeColumnsMode.Fill, Margin = new Padding(0) };
            dgvObjective.Columns.Add("Var", "Variable");
            dgvObjective.Columns.Add("Sign", "Sign (+/-)");
            dgvObjective.Columns.Add("Coeff", "Coefficient");
            dgvObjective.ColumnHeadersHeightSizeMode = DataGridViewColumnHeadersHeightSizeMode.EnableResizing;
            dgvObjective.ColumnHeadersHeight = 40;
            objPanel.Controls.AddRange(new Control[] { dgvObjective, spacerObjective, lblObjective });

            // Sign Restrictions (BOTTOM)
            var signPanel = new Panel { Dock = DockStyle.Bottom, Height = 140, Padding = new Padding(0, 10, 0, 0) };
            var lblSignRestrictions = new Label { Text = "Sign Restrictions (+, -, urs, int, bin):", Dock = DockStyle.Top, Height = 24, TextAlign = ContentAlignment.BottomLeft };
            dgvSignRestrictions = new DataGridView { Dock = DockStyle.Fill, AllowUserToAddRows = true, AutoSizeColumnsMode = DataGridViewAutoSizeColumnsMode.Fill };
            dgvSignRestrictions.Columns.Add("VarName", "Variable");
            var colRestr = new DataGridViewComboBoxColumn { Name = "Restriction", HeaderText = "Restriction" };
            (colRestr as DataGridViewComboBoxColumn)!.Items.AddRange(new[] { "+", "-", "urs", "int", "bin" });
            dgvSignRestrictions.Columns.Add(colRestr);
            signPanel.Controls.AddRange(new Control[] { dgvSignRestrictions, lblSignRestrictions });

            // Constraints (FILL)
            var constraintsPanel = new Panel { Dock = DockStyle.Fill, BackColor = Color.Transparent, Padding = new Padding(0, 16, 0, 0) };
            var lblConstraints = new Label { Text = "Constraints (signs, coefficients, relation, RHS):", Dock = DockStyle.Top, Height = 25, TextAlign = ContentAlignment.BottomLeft };
            var spacerConstraints = new Panel { Dock = DockStyle.Top, Height = 12 };
            dgvConstraints = new DataGridView { Dock = DockStyle.Fill, AllowUserToAddRows = true, AllowUserToDeleteRows = true, AutoSizeColumnsMode = DataGridViewAutoSizeColumnsMode.Fill, Margin = new Padding(0) };
            dgvConstraints.Columns.Add("CName", "Constraint Name");
            dgvConstraints.Columns.Add("TechSigns", "Signs (e.g. + + - ...)");
            dgvConstraints.Columns.Add("TechCoeffs", "Coefficients (e.g. 3 5 2 ...)");
            dgvConstraints.Columns.Add("Relation", "Relation (<=,=,>=)");
            dgvConstraints.Columns.Add("RHS", "Right Hand Side");
            dgvConstraints.ColumnHeadersHeightSizeMode = DataGridViewColumnHeadersHeightSizeMode.EnableResizing;
            dgvConstraints.ColumnHeadersHeight = 40;
            constraintsPanel.Controls.AddRange(new Control[] { dgvConstraints, spacerConstraints, lblConstraints });

            // ORDER
            mainPanel.Controls.Add(constraintsPanel);    // Fill
            mainPanel.Controls.Add(signPanel);           // Bottom
            mainPanel.Controls.Add(objPanel);            // Top
            mainPanel.Controls.Add(selectionPanel);      // Top
            mainPanel.Controls.Add(formatPanel);         // Top
            mainPanel.Controls.Add(topPanel);            // Top

            // Style
            StyleButton(btnLoadModelFile, primary: true);
            StyleButton(btnSaveModelFile);
            StyleButton(btnValidateInput);
            StyleLabel(lblModelFormat, muted: true);
            StyleLabel(lblProblemType);
            StyleLabel(lblObjectiveSense);
            StyleLabel(lblObjective);
            StyleLabel(lblConstraints);
            StyleLabel(lblSignRestrictions);
            StyleCombo(cmbProblemType);
            StyleCombo(cmbObjectiveSense);
            StyleGrid(dgvObjective);
            StyleGrid(dgvConstraints);
            StyleGrid(dgvSignRestrictions);

            tabModelInput.Controls.Add(mainPanel);
        }

        // Builds the Algorithm tab
        private void BuildTabAlgorithm()
        {
            tabAlgorithm = new TabPage("Algorithm");

            var mainPanel = new Panel { Dock = DockStyle.Fill, Padding = new Padding(20), BackColor = Color.Transparent };

            var contentPanel = new Panel { Width = 600, Height = 520, Top = 20, Anchor = AnchorStyles.Top };
            mainPanel.Resize += (s, e) => { contentPanel.Left = Math.Max(0, (mainPanel.ClientSize.Width - contentPanel.Width) / 2); };

            grpAlgorithms = new StyledGroupPanel
            {
                Title = "Select Algorithm",
                Dock = DockStyle.Top,
                Height = 220,
                Margin = new Padding(0, 0, 0, 20),
                Padding = new Padding(16, 36, 16, 16),
                BackColor = Color.Transparent,
                TitleFont = AppTheme.Bold,
                TitleColor = AppTheme.Text,
                BorderColor = AppTheme.Border,
                BackgroundFill = AppTheme.Background,
                CornerRadius = 12
            };

            rbPrimalSimplex = new RadioButton { Text = "Primal Simplex", Left = 20, Top = 40, Width = 250, Height = 25, UseVisualStyleBackColor = true };
            rbRevisedPrimalSimplex = new RadioButton { Text = "Revised Primal Simplex", Left = 20, Top = 70, Width = 250, Height = 25, UseVisualStyleBackColor = true, Checked = true };
            rbBnBSimplex = new RadioButton { Text = "Branch && Bound (Simplex)", Left = 20, Top = 100, Width = 250, Height = 25, UseVisualStyleBackColor = true };
            rbCuttingPlane = new RadioButton { Text = "Cutting Plane", Left = 20, Top = 130, Width = 250, Height = 25, UseVisualStyleBackColor = true };
            rbBnBKnapsack = new RadioButton { Text = "Branch && Bound (Knapsack)", Left = 20, Top = 160, Width = 260, Height = 25, UseVisualStyleBackColor = true };
            grpAlgorithms.Controls.AddRange(new Control[] { rbPrimalSimplex, rbRevisedPrimalSimplex, rbBnBSimplex, rbCuttingPlane, rbBnBKnapsack });

            grpOptions = new StyledGroupPanel
            {
                Title = "Variable Type Options",
                Dock = DockStyle.Top,
                Height = 110,
                Margin = new Padding(0, 20, 0, 20),
                Padding = new Padding(16, 36, 16, 16),
                BackColor = Color.Transparent,
                TitleFont = AppTheme.Bold,
                TitleColor = AppTheme.Text,
                BorderColor = AppTheme.Border,
                BackgroundFill = AppTheme.Background,
                CornerRadius = 12
            };

            chkBinary = new CheckBox { Text = "Binary Variables", Left = 20, Top = 45, Width = 170, Height = 25, UseVisualStyleBackColor = true };
            chkGeneralInteger = new CheckBox { Text = "General Integer Variables", Left = 200, Top = 45, Width = 210, Height = 25, UseVisualStyleBackColor = true };
            grpOptions.Controls.AddRange(new Control[] { chkBinary, chkGeneralInteger });

            var buttonPanel = new Panel { Dock = DockStyle.Top, Height = 90, Padding = new Padding(0, 16, 0, 0) };
            btnSolve = new Button { Text = "Solve Problem", Width = 220, Height = 50, Top = 16 };

            void CenterSolve() => btnSolve.Left = Math.Max(0, (buttonPanel.ClientSize.Width - btnSolve.Width) / 2);
            buttonPanel.Resize += (s, e) => CenterSolve();
            buttonPanel.Controls.Add(btnSolve);
            buttonPanel.CreateControl();
            CenterSolve();

            contentPanel.Controls.Add(buttonPanel);
            contentPanel.Controls.Add(grpOptions);
            contentPanel.Controls.Add(grpAlgorithms);
            mainPanel.Controls.Add(contentPanel);

            // Style
            StyleRadio(rbPrimalSimplex);
            StyleRadio(rbRevisedPrimalSimplex);
            StyleRadio(rbBnBSimplex);
            StyleRadio(rbCuttingPlane);
            StyleRadio(rbBnBKnapsack);
            StyleCheckBox(chkBinary);
            StyleCheckBox(chkGeneralInteger);
            StyleButton(btnSolve, primary: true);

            btnSolve.Click += BtnSolve_Click;

            tabAlgorithm.Controls.Add(mainPanel);
        }

        // Builds the Canonical Form tab
        private void BuildTabCanonical()
        {
            tabCanonical = new TabPage("Canonical Form");

            var mainPanel = new TableLayoutPanel
            {
                Dock = DockStyle.Fill,
                ColumnCount = 1,
                RowCount = 2,
                Padding = new Padding(20),
            };
            mainPanel.RowStyles.Add(new RowStyle(SizeType.Percent, 65));
            mainPanel.RowStyles.Add(new RowStyle(SizeType.Percent, 35));

            dgvCanonicalTableau = new DataGridView
            {
                Dock = DockStyle.Fill,
                AllowUserToAddRows = false,
                AutoSizeColumnsMode = DataGridViewAutoSizeColumnsMode.Fill
            };
            dgvCanonicalTableau.Columns.Add("Basis", "Basis");
            dgvCanonicalTableau.Columns.Add("zj_cj", "zj - cj");
            dgvCanonicalTableau.Columns.Add("x1", "x1");
            dgvCanonicalTableau.Columns.Add("x2", "x2");
            dgvCanonicalTableau.Columns.Add("s1", "s1");
            dgvCanonicalTableau.Columns.Add("b", "b");

            rtbCanonicalNotes = new RichTextBox
            {
                Dock = DockStyle.Fill,
                ReadOnly = true,
                Font = new Font("Consolas", 10F),
                Text = "Canonical form and initial tableau will appear here (GUI scaffold).\nAll values will be rounded to 3 decimals in exports."
            };

            StyleGrid(dgvCanonicalTableau);

            mainPanel.Controls.Add(dgvCanonicalTableau, 0, 0);
            mainPanel.Controls.Add(rtbCanonicalNotes, 0, 1);
            tabCanonical.Controls.Add(mainPanel);
        }

        // Builds the Iterations tab
        private void BuildTabIterations()
        {
            tabIterations = new TabPage("Iterations");

            var mainPanel = new Panel { Dock = DockStyle.Fill, Padding = new Padding(20), BackColor = Color.Transparent };

            var bottomPanel = new Panel { Dock = DockStyle.Bottom, Height = 80, Padding = new Padding(0, 10, 0, 0) };
            btnExpandAll = new Button { Text = "Expand All Steps", Width = 160, Height = 40, Left = 0, Top = 20 };
            btnCollapseAll = new Button { Text = "Collapse All Steps", Width = 160, Height = 40, Left = 180, Top = 20 };
            btnExpandAll.Click += (s, e) => ExpandCollapseAll(true);
            btnCollapseAll.Click += (s, e) => ExpandCollapseAll(false);
            bottomPanel.Controls.Add(btnExpandAll);
            bottomPanel.Controls.Add(btnCollapseAll);

            lvIterations = new ListView
            {
                Dock = DockStyle.Fill,
                View = View.Details,
                FullRowSelect = true,
                GridLines = true,
                Margin = new Padding(0, 0, 0, 10)
            };
            lvIterations.Columns.Add("Step", 80);
            lvIterations.Columns.Add("Phase/Node", 160);
            lvIterations.Columns.Add("Description", 720);

            mainPanel.Controls.Add(bottomPanel);
            mainPanel.Controls.Add(lvIterations);

            StyleButton(btnExpandAll);
            StyleButton(btnCollapseAll);

            tabIterations.Controls.Add(mainPanel);
        }

        // Builds the Results tab
        private void BuildTabResults()
        {
            tabResults = new TabPage("Results");

            var mainPanel = new Panel { Dock = DockStyle.Fill, Padding = new Padding(20), BackColor = Color.Transparent };

            var bottomPanel = new Panel { Dock = DockStyle.Bottom, Height = 80, Padding = new Padding(0, 10, 0, 0) };
            btnExportResults = new Button { Text = "Export Results to File", Width = 200, Height = 40, Left = 0, Top = 20 };
            lblRoundingNote = new Label { Text = "Note: All decimals exported to 3 dp.", AutoSize = true, Left = 220, Top = 28 };
            btnExportResults.Click += BtnExportResults_Click;
            bottomPanel.Controls.Add(btnExportResults);
            bottomPanel.Controls.Add(lblRoundingNote);

            rtbResultsSummary = new RichTextBox
            {
                Dock = DockStyle.Fill,
                ReadOnly = true,
                Font = new Font("Consolas", 10F),
                Margin = new Padding(0, 0, 0, 10)
            };

            mainPanel.Controls.Add(bottomPanel);
            mainPanel.Controls.Add(rtbResultsSummary);

            StyleButton(btnExportResults, primary: true);
            StyleLabel(lblRoundingNote, muted: true);

            tabResults.Controls.Add(mainPanel);
        }

        // Builds the Sensitivity tab
        private void BuildTabSensitivity()
        {
            tabSensitivity = new TabPage("Sensitivity");

            var scroll = new Panel { Dock = DockStyle.Fill, AutoScroll = true, Padding = new Padding(20) };

            // Non-Basic Variable
            pnlSA_VarNonBasic = CreateSAGroup("Non-Basic Variable: Range & Apply Change", 280);
            saNB_VarSelect = new ComboBox { Left = 20, Top = 42, Width = 220, DropDownStyle = ComboBoxStyle.DropDownList };
            saNB_VarSelect.Items.AddRange(new[] { "x1", "x2", "x3" });
            saNB_ShowRange = new Button { Text = "Display Range", Left = 260, Top = 40, Width = 140, Height = 36 };
            saNB_ApplyDelta = new NumericUpDown { Left = 420, Top = 43, Width = 100, DecimalPlaces = 3, Minimum = -100000, Maximum = 100000 };
            saNB_Apply = new Button { Text = "Apply Δcᵢ", Left = 530, Top = 40, Width = 120, Height = 36 };
            saNB_Output = MakeSmallList(20, 90);
            pnlSA_VarNonBasic.Controls.AddRange(new Control[] { saNB_VarSelect, saNB_ShowRange, saNB_ApplyDelta, saNB_Apply, saNB_Output });

            // Basic Variable
            pnlSA_VarBasic = CreateSAGroup("Basic Variable: Range & Apply Change", 240);
            saB_VarSelect = new ComboBox { Left = 20, Top = 42, Width = 220, DropDownStyle = ComboBoxStyle.DropDownList };
            saB_VarSelect.Items.AddRange(new[] { "x1", "x2", "x3" });
            saB_ShowRange = new Button { Text = "Display Range", Left = 260, Top = 40, Width = 140, Height = 36 };
            saB_ApplyDelta = new NumericUpDown { Left = 420, Top = 43, Width = 100, DecimalPlaces = 3, Minimum = -100000, Maximum = 100000 };
            saB_Apply = new Button { Text = "Apply Δ (basic)", Left = 530, Top = 40, Width = 140, Height = 36 };
            saB_Output = MakeSmallList(20, 90);
            pnlSA_VarBasic.Controls.AddRange(new Control[] { saB_VarSelect, saB_ShowRange, saB_ApplyDelta, saB_Apply, saB_Output });

            // RHS
            pnlSA_RHS = CreateSAGroup("Constraint RHS: Range & Apply Change", 240);
            saRHS_ConSelect = new ComboBox { Left = 20, Top = 42, Width = 220, DropDownStyle = ComboBoxStyle.DropDownList };
            saRHS_ConSelect.Items.AddRange(new[] { "c1", "c2", "c3" });
            saRHS_ShowRange = new Button { Text = "Display Range", Left = 260, Top = 40, Width = 140, Height = 36 };
            saRHS_ApplyDelta = new NumericUpDown { Left = 420, Top = 43, Width = 100, DecimalPlaces = 3, Minimum = -100000, Maximum = 100000 };
            saRHS_Apply = new Button { Text = "Apply Δbⱼ", Left = 530, Top = 40, Width = 120, Height = 36 };
            saRHS_Output = MakeSmallList(20, 90);
            pnlSA_RHS.Controls.AddRange(new Control[] { saRHS_ConSelect, saRHS_ShowRange, saRHS_ApplyDelta, saRHS_Apply, saRHS_Output });

            // Column analysis
            pnlSA_Column = CreateSAGroup("Non-Basic Column: Range & Coeff Changes", 220);
            saCol_VarSelect = new ComboBox { Left = 20, Top = 42, Width = 220, DropDownStyle = ComboBoxStyle.DropDownList };
            saCol_VarSelect.Items.AddRange(new[] { "x1", "x2", "x3" });
            saCol_ShowRange = new Button { Text = "Display Range", Left = 260, Top = 40, Width = 140, Height = 36 };
            saCol_EditCoeffs = new Button { Text = "Edit Column Coeffs…", Left = 410, Top = 40, Width = 180, Height = 36 };
            saCol_Output = MakeSmallList(20, 90);
            pnlSA_Column.Controls.AddRange(new Control[] { saCol_VarSelect, saCol_ShowRange, saCol_EditCoeffs, saCol_Output });

            // Add activity
            pnlSA_AddActivity = CreateSAGroup("Add New Activity (Column)", 200);
            saAddAct_Add = new Button { Text = "Add Activity…", Left = 20, Top = 42, Width = 160, Height = 36 };
            saAddAct_Output = MakeSmallList(200, 20); saAddAct_Output.Top = 40; saAddAct_Output.Left = 200;
            pnlSA_AddActivity.Controls.AddRange(new Control[] { saAddAct_Add, saAddAct_Output });

            // Add constraint
            pnlSA_AddConstraint = CreateSAGroup("Add New Constraint (Row)", 200);
            saAddCon_Add = new Button { Text = "Add Constraint…", Left = 20, Top = 42, Width = 160, Height = 36 };
            saAddCon_Output = MakeSmallList(200, 20); saAddCon_Output.Top = 40; saAddCon_Output.Left = 200;
            pnlSA_AddConstraint.Controls.AddRange(new Control[] { saAddCon_Add, saAddCon_Output });

            // Shadow Prices
            pnlSA_ShadowPrices = CreateSAGroup("Shadow Prices", 200);
            saShadow_Show = new Button { Text = "Display Shadow Prices", Left = 20, Top = 42, Width = 200, Height = 36 };
            saShadow_Output = MakeSmallList(240, 20); saShadow_Output.Top = 40; saShadow_Output.Left = 240;
            pnlSA_ShadowPrices.Controls.AddRange(new Control[] { saShadow_Show, saShadow_Output });

            // Duality
            pnlSA_Duality = CreateSAGroup("Duality", 220);
            saDual_Build = new Button { Text = "Build Dual", Left = 20, Top = 42, Width = 130, Height = 36 };
            saDual_Solve = new Button { Text = "Solve Dual", Left = 160, Top = 42, Width = 130, Height = 36 };
            saDual_Verify = new Button { Text = "Verify Strong/Weak Duality", Left = 300, Top = 42, Width = 230, Height = 36 };
            saDual_Output = MakeSmallList(20, 90);
            pnlSA_Duality.Controls.AddRange(new Control[] { saDual_Build, saDual_Solve, saDual_Verify, saDual_Output });

            // Stack vertically
            int y = 0;
            foreach (var panel in new[]
                     { pnlSA_VarNonBasic, pnlSA_VarBasic, pnlSA_RHS, pnlSA_Column, pnlSA_AddActivity, pnlSA_AddConstraint, pnlSA_ShadowPrices, pnlSA_Duality })
            {
                panel.Top = y;
                panel.Left = 0;
                panel.Width = 900;
                y += panel.Height + 16;
                scroll.Controls.Add(panel);
            }

            // Style inside
            foreach (var b in new[] { saNB_ShowRange, saNB_Apply, saB_ShowRange, saB_Apply, saRHS_ShowRange, saRHS_Apply, saCol_ShowRange, saCol_EditCoeffs, saAddAct_Add, saAddCon_Add, saShadow_Show, saDual_Build, saDual_Solve, saDual_Verify })
                StyleButton(b);
            foreach (var c in new[] { saNB_VarSelect, saB_VarSelect, saRHS_ConSelect, saCol_VarSelect })
                StyleCombo(c);
            foreach (var n in new[] { saNB_ApplyDelta, saB_ApplyDelta, saRHS_ApplyDelta }) { n.BackColor = AppTheme.Card; n.ForeColor = AppTheme.Text; }

            tabSensitivity.Controls.Add(scroll);
        }

        // Helper to create a styled group panel for sensitivity analysis
        private StyledGroupPanel CreateSAGroup(string title, int height)
        {
            return new StyledGroupPanel
            {
                Title = title,
                Height = height,
                Padding = new Padding(16, 36, 16, 16),
                TitleFont = AppTheme.Bold,
                TitleColor = AppTheme.Text,
                BorderColor = AppTheme.Border,
                BackgroundFill = AppTheme.Background,
                CornerRadius = 12
            };
        }

        // Helper to create a small ListView for output
        private ListView MakeSmallList(int left, int top)
        {
            var lv = new ListView
            {
                Left = left,
                Top = top,
                Width = 640,
                Height = 110,
                View = View.Details,
                FullRowSelect = true,
                GridLines = true
            };
            lv.Columns.Add("Result", 600);
            return lv;
        }

        // Builds the Node Explorer tab
        private void BuildTabNodes()
        {
            tabNodes = new TabPage("Node Explorer");

            splitNodes = new SplitContainer { Dock = DockStyle.Fill, SplitterDistance = 320, Padding = new Padding(10), FixedPanel = FixedPanel.Panel1 };
            tvNodes = new TreeView { Dock = DockStyle.Fill };
            tvNodes.AfterSelect += (s, e) => { sbNode.Text = $"Node: {e.Node.Text}"; };

            nodeDetailsPanel = new Panel { Dock = DockStyle.Fill, Padding = new Padding(10) };
            lblNodeTitle = new Label { Text = "Node: (select on left)", AutoSize = true, Top = 10, Left = 10, Font = AppTheme.Bold };
            lblNodeStatus = new Label { Text = "Status: –", AutoSize = true, Top = 40, Left = 10 };
            lblNodeBound = new Label { Text = "Bound: –", AutoSize = true, Top = 65, Left = 10 };
            lblNodeIncumbent = new Label { Text = "Best Incumbent: –", AutoSize = true, Top = 90, Left = 10 };

            lvNodeIterations = new ListView { View = View.Details, Dock = DockStyle.Bottom, Height = 380, FullRowSelect = true, GridLines = true };
            lvNodeIterations.Columns.Add("Iter", 60);
            lvNodeIterations.Columns.Add("Action", 160);
            lvNodeIterations.Columns.Add("Details", 480);

            nodeDetailsPanel.Controls.AddRange(new Control[] { lblNodeTitle, lblNodeStatus, lblNodeBound, lblNodeIncumbent, lvNodeIterations });

            splitNodes.Panel1.Controls.Add(tvNodes);
            splitNodes.Panel2.Controls.Add(nodeDetailsPanel);

            // Seed with placeholders
            var root = tvNodes.Nodes.Add("Root");
            root.Nodes.Add("x1 ≤ 1");
            root.Nodes.Add("x1 ≥ 2");
            root.Expand();

            tabNodes.Controls.Add(splitNodes);
        }

        // Builds the Cuts tab
        private void BuildTabCuts()
        {
            tabCuts = new TabPage("Cuts");

            var pan = new Panel { Dock = DockStyle.Fill, Padding = new Padding(20) };
            lvCuts = new ListView { Dock = DockStyle.Fill, View = View.Details, FullRowSelect = true, GridLines = true };
            lvCuts.Columns.Add("Step", 60);
            lvCuts.Columns.Add("Cut Type", 160);
            lvCuts.Columns.Add("Expression", 520);

            var bottom = new Panel { Dock = DockStyle.Bottom, Height = 72 };
            btnAddCut = new Button { Text = "Add Cut…", Left = 0, Top = 16, Width = 140, Height = 36 };
            btnClearCuts = new Button { Text = "Clear", Left = 150, Top = 16, Width = 100, Height = 36 };
            StyleButton(btnAddCut);
            StyleButton(btnClearCuts);
            bottom.Controls.AddRange(new Control[] { btnAddCut, btnClearCuts });

            pan.Controls.Add(bottom);
            pan.Controls.Add(lvCuts);
            tabCuts.Controls.Add(pan);
        }

        // -------------------- Helpers --------------------

        // Applies the theme to the main form and menu/status controls
        private void ApplyTheme()
        {
            BackColor = AppTheme.Background;
            ForeColor = AppTheme.Text;
            Font = AppTheme.Default;

            if (mainMenu != null) { mainMenu.BackColor = AppTheme.Card; mainMenu.ForeColor = AppTheme.Text; }
            if (statusStrip != null) { statusStrip.BackColor = AppTheme.Card; statusStrip.ForeColor = AppTheme.Text; }

            tabMain.Padding = new Point(0, 0);
        }

        // Sets the algorithm status in the status bar
        private void SetAlgoStatus(string name) => sbAlgo.Text = $"Alg: {name}";

        // Gets the selected algorithm name from radio buttons
        private string GetSelectedAlgorithmName()
        {
            if (rbPrimalSimplex.Checked) return "Primal Simplex";
            if (rbRevisedPrimalSimplex.Checked) return "Revised Primal Simplex";
            if (rbBnBSimplex.Checked) return "Branch & Bound (Simplex)";
            if (rbCuttingPlane.Checked) return "Cutting Plane";
            if (rbBnBKnapsack.Checked) return "Branch & Bound (Knapsack)";
            return "Unknown";
        }

        // Generates model text from the UI (placeholder)
        private string GenerateModelText()
        {
            return "// Model text generation to be implemented";
        }

        // Expands or collapses all iteration steps (placeholder)
        private void ExpandCollapseAll(bool expand)
        {
            MessageBox.Show(expand ? "Expanded all iteration steps." : "Collapsed all iteration steps.",
                            "Iterations", MessageBoxButtons.OK, MessageBoxIcon.Information);
        }

        // ---------- Styled Group Panel ----------
        internal class StyledGroupPanel : Panel
        {
            public string Title { get; set; } = "";
            public Font TitleFont { get; set; } = SystemFonts.DefaultFont;
            public Color TitleColor { get; set; } = Color.Black;
            public Color BorderColor { get; set; } = Color.Gray;
            public Color BackgroundFill { get; set; } = Color.White;
            public int CornerRadius { get; set; } = 8;

            protected override void OnPaint(PaintEventArgs e)
            {
                base.OnPaint(e);

                e.Graphics.SmoothingMode = SmoothingMode.AntiAlias;

                var titleSize = TextRenderer.MeasureText(Title, TitleFont);
                int titlePadX = 20;
                int titlePadY = 8;

                int borderTop = titlePadY + (titleSize.Height / 2);
                var bodyRect = new Rectangle(1, borderTop, Width - 2, Height - borderTop - 1);

                using (var path = CreateRoundRectPath(bodyRect, CornerRadius))
                {
                    using (var fill = new SolidBrush(BackgroundFill))
                        e.Graphics.FillPath(fill, path);

                    using (var pen = new Pen(BorderColor, 1.5f))
                        e.Graphics.DrawPath(pen, path);
                }

                var titleBgRect = new Rectangle(titlePadX - 4, titlePadY - 2, titleSize.Width + 8, titleSize.Height + 4);
                using (var bg = new SolidBrush(Parent?.BackColor ?? BackgroundFill))
                    e.Graphics.FillRectangle(bg, titleBgRect);

                TextRenderer.DrawText(e.Graphics, Title, TitleFont,
                    new Point(titlePadX, titlePadY), TitleColor,
                    TextFormatFlags.Left | TextFormatFlags.Top | TextFormatFlags.NoPadding);
            }
        }

        // -------------------- Event Handlers (bottom) --------------------

        // Handles loading a model file
        private void BtnLoadModelFile_Click(object sender, EventArgs e)
        {
            using var ofd = new OpenFileDialog
            {
                Filter = "Text files (*.txt)|*.txt|All files (*.*)|*.*",
                Title = "Load LP/IP Model File"
            };
            if (ofd.ShowDialog() == DialogResult.OK)
            {
                try
                {
                    _rawModelText = File.ReadAllText(ofd.FileName);
                    MessageBox.Show($"Model file loaded successfully!\n\nFile: {Path.GetFileName(ofd.FileName)}",
                                    "Success", MessageBoxButtons.OK, MessageBoxIcon.Information);
                    sbStatus.Text = "Model loaded.";
                }
                catch (Exception ex)
                {
                    MessageBox.Show($"Error loading file: {ex.Message}",
                                    "Error", MessageBoxButtons.OK, MessageBoxIcon.Error);
                }
            }
        }

        // Handles saving a model file
        private void BtnSaveModelFile_Click(object sender, EventArgs e)
        {
            using var sfd = new SaveFileDialog
            {
                Filter = "Text files (*.txt)|*.txt",
                FileName = "model.txt",
                Title = "Save LP/IP Model File"
            };
            if (sfd.ShowDialog() == DialogResult.OK)
            {
                try
                {
                    string modelText = GenerateModelText(); // TODO
                    File.WriteAllText(sfd.FileName, modelText);
                    MessageBox.Show($"Model saved successfully!\n\nFile: {Path.GetFileName(sfd.FileName)}",
                                    "Success", MessageBoxButtons.OK, MessageBoxIcon.Information);
                    sbStatus.Text = "Model saved.";
                }
                catch (Exception ex)
                {
                    MessageBox.Show($"Error saving file: {ex.Message}",
                                    "Error", MessageBoxButtons.OK, MessageBoxIcon.Error);
                }
            }
        }

        // Handles input validation
        private void BtnValidateInput_Click(object? sender, EventArgs e)
        {
            // GUI-only: pretend validation passed
            MessageBox.Show("Input format looks valid (placeholder).\n\nParsing & population to be implemented.", "Validate Input", MessageBoxButtons.OK, MessageBoxIcon.Information);
            sbStatus.Text = "Input validated.";
        }

        // Handles solving the problem
        private void BtnSolve_Click(object sender, EventArgs e)
        {
            try
            {
                rtbResultsSummary.Clear();
                rtbResultsSummary.AppendText("=== LP/IP SOLVER RESULTS ===\n\n");
                rtbResultsSummary.AppendText($"Problem Type: {cmbProblemType.SelectedItem}\n");
                rtbResultsSummary.AppendText($"Objective Sense: {cmbObjectiveSense.SelectedItem}\n");
                rtbResultsSummary.AppendText($"Algorithm: {GetSelectedAlgorithmName()}\n");
                rtbResultsSummary.AppendText($"Binary Variables: {(chkBinary.Checked ? "Yes" : "No")}\n");
                rtbResultsSummary.AppendText($"Integer Variables: {(chkGeneralInteger.Checked ? "Yes" : "No")}\n\n");
                rtbResultsSummary.AppendText("STATUS: Ready to solve (GUI scaffold)\n");
                rtbResultsSummary.AppendText("OPTIMAL VALUE: [To be calculated]\n");
                rtbResultsSummary.AppendText("SOLUTION VECTOR: [To be calculated]\n\n");
                rtbResultsSummary.AppendText("Note: Algorithm implementation in progress...\n");

                sbStatus.Text = "Solve started (placeholder).";
                sbIter.Text = "Iter: 0";
                tabMain.SelectedTab = tabResults;
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Error during solving: {ex.Message}",
                                "Error", MessageBoxButtons.OK, MessageBoxIcon.Error);
            }
        }

        // Handles exporting results
        private void BtnExportResults_Click(object sender, EventArgs e)
        {
            using var sfd = new SaveFileDialog
            {
                Filter = "Text files(*.txt) | *.txt",
                FileName = "results.txt",
                Title = "Export Results"
            };
            if (sfd.ShowDialog() == DialogResult.OK)
            {
                try
                {
                    File.WriteAllText(sfd.FileName, rtbResultsSummary.Text);
                    MessageBox.Show($"Results exported successfully!\n\nFile: {Path.GetFileName(sfd.FileName)}",
                                    "Success", MessageBoxButtons.OK, MessageBoxIcon.Information);
                    sbStatus.Text = "Results exported.";
                }
                catch (Exception ex)
                {
                    MessageBox.Show($"Error exporting results: {ex.Message}",
                                    "Error", MessageBoxButtons.OK, MessageBoxIcon.Error);
                }
            }
        }
    }

    /// <summary>
    /// A TabControl whose tab headers are hidden. Pages are still switchable programmatically.
    /// </summary>
    internal class HiddenTabControl : TabControl
    {
        public HiddenTabControl()
        {
            // Hide headers by making them 1px tall; fixed sizing prevents WinForms from recalculating.
            this.Appearance = TabAppearance.Buttons;
            this.ItemSize = new Size(0, 1);
            this.SizeMode = TabSizeMode.Fixed;
            this.Multiline = true;
            this.Padding = new Point(0, 0);
        }

        protected override void OnKeyDown(KeyEventArgs ke)
        {
            // Optional: prevent Ctrl+Tab cycling since headers are hidden
            if (ke.Control && (ke.KeyCode == Keys.Tab)) { ke.Handled = true; return; }
            base.OnKeyDown(ke);
        }
    }
}
